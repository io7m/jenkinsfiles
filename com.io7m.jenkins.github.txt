#!groovy

pipeline {

  agent none

  stages {
    stage('BuildAndTest') {
      parallel {
        stage('linux:openjdk-11-hotspot') {
          agent { label 'linux' }
          tools {
            jdk   'openjdk-11-hotspot'
            maven 'maven-3.6.1'
          }
          steps {
            script {
              def pom = readMavenPom file: 'pom.xml'
              if (pom.version.endsWith("-SNAPSHOT")) {
                echo "${pom.version} is a -SNAPSHOT version; deploy to Central"
                withMaven(
                  maven: 'maven-3.6.1',
                  mavenLocalRepo: '.repository') {
                  sh 'env | sort'
                  sh 'mvn -C -e -U -Dio7m.release=true clean deploy site'
                }
              } else {
                echo "${pom.version} is not a -SNAPSHOT version; doing a plain build"
                withMaven(
                  maven: 'maven-3.6.1',
                  mavenLocalRepo: '.repository') {
                  sh 'env | sort'
                  sh 'mvn -C -e -U clean install site'
                }
              }
            }
          }
        }
      }
    }
  }

  post {
    success {
      node('mustard') {
        script {
          withMaven(
            maven: 'maven-3.6.1',
            mavenLocalRepo: '.repository') {
            withCredentials([
              usernamePassword(
                credentialsId: 'arc7-jms-credentials',
                passwordVariable: 'JENKINS_JMS_PASSWORD',
                usernameVariable: 'JENKINS_JMS_USER'
              ),
              file(
                credentialsId: 'arc7-jenkins-trust-store',
                variable: 'JENKINS_JMS_TRUST_STORE'
              ),
              string(
                credentialsId: 'arc7-jenkins-trust-store-password',
                variable: 'JENKINS_JMS_TRUST_STORE_PASSWORD'
              )
            ]) {
              sh ".jenkins/notify.sh success"
            }
          }
        }
      }
    }
    failure {
      node('mustard') {
        script {
          withMaven(
            maven: 'maven-3.6.1',
            mavenLocalRepo: '.repository') {
            withCredentials([
              usernamePassword(
                credentialsId: 'arc7-jms-credentials',
                passwordVariable: 'JENKINS_JMS_PASSWORD',
                usernameVariable: 'JENKINS_JMS_USER'
              ),
              file(
                credentialsId: 'arc7-jenkins-trust-store',
                variable: 'JENKINS_JMS_TRUST_STORE'
              ),
              string(
                credentialsId: 'arc7-jenkins-trust-store-password',
                variable: 'JENKINS_JMS_TRUST_STORE_PASSWORD'
              )
            ]) {
              sh ".jenkins/notify.sh failure"
            }
          }
        }
      }
    }
  }

}

